<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ç”Ÿæ—¥å¿«ä¹ - é­”æ³•ç²’å­ v6.0 (åŸç‰ˆå¤åˆ»+åŠŸèƒ½æ•´åˆ)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Noto+Serif+SC:wght@500;700&display=swap" rel="stylesheet">
    
    <!-- MediaPipe è¾…åŠ©åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    
    <!-- MediaPipe æ ¸å¿ƒåº“ -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4.1646424915/hands.js" crossorigin="anonymous"></script>

    <style>
        :root { --bg-gradient: radial-gradient(circle at center, #1a0b1a 0%, #000000 100%); }
        body { 
            margin: 0; padding: 0; overflow: hidden; 
            background-color: #000000; background-image: var(--bg-gradient); 
            font-family: 'Noto Serif SC', serif; color: white; 
            user-select: none; -webkit-tap-highlight-color: transparent; 
        }
        #canvas-container { position: absolute; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 1; }
        
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; display: flex; flex-direction: column; justify-content: space-between; padding: 1.5rem; box-sizing: border-box; }
        .glass-panel { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 1.5rem; box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5); }
        .interactive-element { pointer-events: auto; cursor: pointer; }

        /* æ‘„åƒå¤´é¢„è§ˆæ¡† */
        #camera-preview-box {
            position: fixed; top: 5rem; right: 1rem; width: 140px; z-index: 40;
            transition: opacity 0.5s ease, transform 0.5s ease; pointer-events: auto; 
        }
        @media (min-width: 640px) { #camera-preview-box { width: 180px; right: 2rem; } }
        #camera-preview-box.hidden-fade { opacity: 0; pointer-events: none; transform: scale(0.8); }

        /* å¹æ°”æ¡ */
        #blow-meter-container { width: 280px; height: 12px; background: rgba(255,255,255,0.1); border-radius: 10px; overflow: hidden; opacity: 0; transition: opacity 0.5s; margin: 0 auto; }
        #blow-meter-bar { height: 100%; width: 0%; background: linear-gradient(90deg, #ff9a9e 0%, #ff69b4 100%); border-radius: 10px; transition: width 0.1s linear; box-shadow: 0 0 15px #ff69b4; }
        
        /* æƒŠå–œå±‚ */
        #surprise-layer { 
            position: absolute; inset: 0; display: flex; flex-direction: column; justify-content: center; align-items: center; 
            z-index: 80; pointer-events: none; transition: background 0.5s ease; opacity: 0;
        }
        #surprise-layer.active { pointer-events: auto; background: rgba(0,0,0,0.6); backdrop-filter: blur(8px); opacity: 1; }

        .pop-in { animation: popIn 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }
        @keyframes popIn { 0% { opacity: 0; transform: scale(0.9) translateY(30px); } 100% { opacity: 1; transform: scale(1) translateY(0); } }
        
        .font-handwriting { font-family: 'Dancing Script', cursive; }
        .neon-text { text-shadow: 0 0 10px rgba(255,105,180,0.7), 0 0 20px rgba(255,105,180,0.5); }

        /* 3D ç¿»è½¬å¡ç‰‡ */
        .flip-card { background-color: transparent; perspective: 1000px; width: 320px; height: 480px; }
        .flip-card-inner {
            position: relative; width: 100%; height: 100%; text-align: center;
            transition: transform 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            transform-style: preserve-3d;
        }
        .flip-card.flipped .flip-card-inner { transform: rotateY(180deg); }
        .flip-card-front, .flip-card-back {
            position: absolute; width: 100%; height: 100%;
            -webkit-backface-visibility: hidden; backface-visibility: hidden;
            border-radius: 1.2rem; overflow: hidden;
        }
        .flip-card-back { transform: rotateY(180deg); }
        
        /* æµ®åŠ¨ç¤¼ç‰©æŒ‰é’® */
        .animate-float { animation: float-btn 3s ease-in-out infinite; }
        @keyframes float-btn { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
    </style>
</head>
<body>

    <audio id="bgm" loop>
        <source src="https://upload.wikimedia.org/wikipedia/commons/6/6e/Happy_Birthday_to_You_-_Instrumental.ogg" type="audio/ogg">
    </audio>

    <video class="input_video" playsinline style="display:none"></video>
    <div id="canvas-container"></div>

    <!-- æ‘„åƒå¤´é¢„è§ˆ/è°ƒè¯•æ¡† -->
    <div id="camera-preview-box" class="glass-panel p-1.5 flex flex-col gap-1 border-rainbow hidden-fade">
        <div class="relative w-full aspect-[4/3] bg-black/60 rounded-lg overflow-hidden border border-white/10">
            <canvas id="output_canvas" class="w-full h-full object-cover transform -scale-x-100"></canvas>
            <div id="cam-indicator" class="absolute top-2 right-2 w-2.5 h-2.5 rounded-full bg-red-500 shadow-md transition-colors duration-300"></div>
            <div id="cam-overlay-text" class="absolute inset-0 flex items-center justify-center bg-black/40 text-[10px] text-white/80 pointer-events-none hidden">
                Camera Active
            </div>
        </div>
        <div class="flex justify-between items-center px-1">
            <span class="text-[9px] text-slate-400 uppercase tracking-widest">Hand Vision</span>
            <span class="text-[9px] text-emerald-400" id="cam-status-text">WAITING...</span>
        </div>
    </div>

    <!-- UI Layer -->
    <div id="ui-layer">
        <div class="flex justify-between items-start w-full">
            <div class="glass-panel px-4 py-2">
                <div id="status-dot" class="inline-block w-2 h-2 rounded-full bg-red-500 mr-2 shadow-[0_0_8px_red]"></div>
                <span id="status-text" class="text-xs md:text-sm text-gray-300 tracking-wider">SYSTEM READY</span>
            </div>
            <button id="music-btn" class="interactive-element p-3 glass-panel hover:bg-white/20 transition rounded-full active:scale-90">ğŸµ</button>
        </div>

        <div id="center-instruction" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-center pointer-events-none w-full z-0">
            <div class="flex items-center justify-center gap-4 mb-2">
                <span id="hand-icon" class="text-6xl animate-bounce">ğŸ‘‹</span>
                <h2 id="instruction-text" class="text-6xl md:text-8xl font-bold text-white neon-text transition-all duration-700">ä¸¾èµ·åŒæ‰‹</h2>
            </div>
            <p id="sub-instruction" class="mt-4 text-xl md:text-2xl text-pink-200/80 font-light tracking-[0.3em]">è®©é­”æ³•å‘ç”Ÿ</p>
            
            <div id="blow-hint" class="mt-8 opacity-0 transition-opacity duration-500">
                <p class="text-lg font-bold text-pink-200 mb-1">ğŸ¤ å¯¹ç€éº¦å…‹é£å¹æ°”</p>
                <p class="text-xs text-gray-400">(æˆ–é•¿æŒ‰å±å¹•æ¨¡æ‹Ÿå¹æ°”)</p>
            </div>
            <div id="blow-meter-container" class="mt-2">
                <div id="blow-meter-bar"></div>
            </div>
        </div>
    </div>

    <!-- æƒŠå–œå±‚ -->
    <div id="surprise-layer">
        <button id="reveal-btn" class="interactive-element hidden px-10 py-5 bg-white text-pink-600 rounded-full font-bold text-2xl shadow-[0_0_60px_rgba(255,105,180,0.8)] hover:scale-105 transition-transform duration-300 animate-float pop-in">ğŸ æ‰“å¼€ç¤¼ç‰©</button>
        
        <div id="flip-card-container" class="hidden flip-card pop-in interactive-element">
            <div class="flip-card-inner">
                <!-- æ­£é¢ -->
                <div class="flip-card-front glass-panel bg-gradient-to-br from-pink-500/40 to-purple-600/40 border border-white/30 p-1">
                    <div class="bg-black/80 rounded-[1rem] p-6 h-full flex flex-col backdrop-blur-md">
                        <div class="w-full aspect-[4/3] bg-gray-800 rounded-lg mb-6 overflow-hidden relative border border-white/10 shadow-inner">
                            <img src="https://images.unsplash.com/photo-1549465220-1a8b9238cd48?q=80&w=800&auto=format&fit=crop" class="w-full h-full object-cover" alt="Gift">
                            <div class="absolute bottom-3 left-4 text-white/90 font-handwriting text-2xl">Happy Birthday!</div>
                        </div>
                        <div class="text-center mt-auto mb-4">
                            <p class="text-gray-300 mb-6 font-light leading-relaxed">è¿™ä¸ä»…ä»…æ˜¯ä¸€åœºæ•°å­—çƒŸèŠ±ï¼Œ<br>æ›´æ˜¯ä¸ºä½ å‡†å¤‡çš„ä¸“å±æ—¶åˆ»ã€‚</p>
                            <button id="next-surprise-btn" class="w-full py-3 bg-gradient-to-r from-pink-600 to-purple-700 rounded-xl font-bold text-white shadow-lg hover:brightness-110 active:scale-95 transition">ç‚¹å‡»ç¿»è½¬å¡ç‰‡ âœ¨</button>
                        </div>
                    </div>
                </div>
                <!-- èƒŒé¢ -->
                <div class="flip-card-back glass-panel bg-gradient-to-br from-purple-500/40 to-blue-600/40 border border-white/30 p-1">
                    <div class="bg-black/90 rounded-[1rem] p-8 h-full flex flex-col items-center justify-center backdrop-blur-md">
                        <div class="mb-6 text-5xl animate-bounce">ğŸ’Œ</div>
                        <h3 class="text-2xl font-bold text-pink-300 mb-6 font-handwriting">è‡´æœ€ç‰¹åˆ«çš„ä½ </h3>
                        <div id="typewriter-text" class="text-left text-gray-200 space-y-4 font-light leading-7 text-sm md:text-base border-l-2 border-pink-500/50 pl-4 mb-8 min-h-[120px] w-full"></div>
                        <button id="close-card-btn" class="px-8 py-2 rounded-full border border-white/30 text-gray-300 hover:bg-white/10 hover:text-white transition text-sm">æ”¶èµ·å¡ç‰‡</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- å¯åŠ¨é¡µ -->
    <div id="start-overlay" class="fixed inset-0 z-50 flex items-center justify-center bg-black/90">
        <div class="text-center max-w-md p-8 glass-panel mx-4">
            <h1 class="text-6xl mb-2 font-handwriting text-transparent bg-clip-text bg-gradient-to-r from-pink-300 to-purple-400 drop-shadow-lg">Happy Birthday</h1>
            <div class="space-y-4 text-gray-200 text-lg mb-8 font-light mt-6">
                <p>ğŸ‘‹ <b>ä¸¾èµ·åŒæ‰‹</b> å”¤é†’é­”æ³•</p>
                <p>ğŸ’¨ <b>æŒç»­å¹æ°”</b> è®¸ä¸‹å¿ƒæ„¿</p>
            </div>
            <button id="start-btn" class="px-12 py-4 bg-gradient-to-r from-pink-600 to-purple-700 rounded-full font-bold text-xl hover:scale-105 active:scale-95 transition transform shadow-[0_0_20px_rgba(255,105,180,0.5)] text-white border border-white/20">è¿›å…¥é­”æ³•ä¸–ç•Œ</button>
            <div id="loading-text" class="hidden mt-4 text-pink-300 text-sm">æ­£åœ¨åŠ è½½èµ„æº...</div>
        </div>
    </div>

    <script>
        // --- æ ¸å¿ƒé…ç½® (è¿˜åŸ index_t copy.html) ---
        const CAKE_THEME = {
            bottom: "#FF69B4", // äº®ç²‰è‰²
            top: "#FFB6C1",    // æµ…ç²‰è‰²
            cream: "#FFFFFF",  // å¥¶æ²¹ç™½
            ring: "#8A2BE2"    // é­”æ³•ç´«ç¯
        };

        const VISUAL_CONFIG = { 
            particleCount: 5000, 
            color: 0xff69b4, 
            blowThreshold: 20
        };

        const STATE = { IDLE: 0, COUNTDOWN: 1, CAKE: 2, BLOWING: 3, CELEBRATION: 4 };
        let currentState = STATE.IDLE;
        
        let particlesData = [];
        let scene, camera, renderer, particleSystem;
        let time = 0;
        let shapeCache = {}; 
        let blowProgress = 0;
        let isSpacePressed = false; 
        let isTouching = false; 
        
        let audioContext, analyser;
        const bgm = document.getElementById('bgm');

        // UI å¼•ç”¨
        const ui = {
            statusText: document.getElementById('status-text'),
            statusDot: document.getElementById('status-dot'),
            mainText: document.getElementById('instruction-text'),
            subText: document.getElementById('sub-instruction'),
            handIcon: document.getElementById('hand-icon'),
            blowMeter: document.getElementById('blow-meter-container'),
            blowBar: document.getElementById('blow-meter-bar'),
            blowHint: document.getElementById('blow-hint'),
            surpriseLayer: document.getElementById('surprise-layer'),
            revealBtn: document.getElementById('reveal-btn'),
            cardContainer: document.getElementById('flip-card-container'), 
            typewriter: document.getElementById('typewriter-text'),
            nextBtn: document.getElementById('next-surprise-btn'),
            closeBtn: document.getElementById('close-card-btn'),
            
            cameraPreview: document.getElementById('camera-preview-box'),
            camIndicator: document.getElementById('cam-indicator'),
            camStatus: document.getElementById('cam-status-text'),
            outputCanvas: document.getElementById('output_canvas')
        };

        /* --- 1. Three.js æ ¸å¿ƒé€»è¾‘ (å®Œå…¨å¤åˆ»ç‰ˆ) --- */
        function initThree() {
            const container = document.getElementById('canvas-container');
            scene = new THREE.Scene();
            scene.fog = new THREE.FogExp2(0x000000, 0.002);
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = 50;
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            container.appendChild(renderer.domElement);
            
            createParticles();
            // é¢„åŠ è½½å½¢çŠ¶
            setTimeout(() => {
                shapeCache['3'] = getShapePoints('text', '3');
                shapeCache['2'] = getShapePoints('text', '2');
                shapeCache['1'] = getShapePoints('text', '1');
                shapeCache['cake'] = getShapePoints('cake');
            }, 100);

            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
            animate();
        }

        // æ ¸å¿ƒï¼šä½¿ç”¨ Canvas ç”»åœ†ç‚¹è´´å›¾ (å¤åˆ»)
        function getCircleTexture() {
            const c = document.createElement('canvas'); c.width=32; c.height=32;
            const ctx=c.getContext('2d');
            const g=ctx.createRadialGradient(16,16,0,16,16,16);
            g.addColorStop(0,'rgba(255,255,255,1)'); 
            g.addColorStop(1,'rgba(255,255,255,0)');
            ctx.fillStyle=g; ctx.fillRect(0,0,32,32);
            return new THREE.CanvasTexture(c);
        }

        function createParticles() {
            const geometry = new THREE.BufferGeometry();
            const positions = new Float32Array(VISUAL_CONFIG.particleCount * 3);
            const colors = new Float32Array(VISUAL_CONFIG.particleCount * 3);
            const sizes = new Float32Array(VISUAL_CONFIG.particleCount);
            particlesData = [];
            const c = new THREE.Color(VISUAL_CONFIG.color);

            for (let i = 0; i < VISUAL_CONFIG.particleCount; i++) {
                const x = (Math.random() - 0.5) * 200;
                const y = (Math.random() - 0.5) * 200;
                const z = (Math.random() - 0.5) * 100;
                positions[i * 3] = x; positions[i * 3 + 1] = y; positions[i * 3 + 2] = z;
                colors[i * 3] = c.r; colors[i * 3 + 1] = c.g; colors[i * 3 + 2] = c.b;
                sizes[i] = Math.random() * 2;
                particlesData.push({
                    current: new THREE.Vector3(x, y, z),
                    target: new THREE.Vector3(x, y, z),
                    baseTarget: new THREE.Vector3(x, y, z),
                    type: 'bg',
                    layer: null,
                    targetColor: c.clone(),
                    noiseOffset: Math.random() * 100,
                    angle: Math.random() * Math.PI * 2, 
                    radius: 20 + Math.random() * 40,
                    orbitSpeed: (Math.random() - 0.5) * 0.02
                });
            }
            geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
            geometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));
            geometry.setAttribute('size', new THREE.BufferAttribute(sizes, 1));
            
            // ä½¿ç”¨ PointsMaterial + è´´å›¾ (å¤åˆ»)
            const material = new THREE.PointsMaterial({ 
                size: 1.5, 
                vertexColors: true, 
                map: getCircleTexture(), 
                transparent: true, 
                opacity: 0.8, // åŸç‰ˆé€æ˜åº¦
                depthWrite: false, 
                blending: THREE.AdditiveBlending 
            });
            particleSystem = new THREE.Points(geometry, material);
            scene.add(particleSystem);
        }

        // æ ¸å¿ƒï¼šè›‹ç³•ç”Ÿæˆé€»è¾‘ (å®Œå…¨å¤åˆ»ï¼ŒåŒ…å« Ring)
        function getShapePoints(type, text) {
            const points = [];
            if (type === 'text') {
                const c = document.createElement('canvas'); c.width=200; c.height=200;
                const ctx=c.getContext('2d');
                ctx.font = 'bold 100px Arial';
                ctx.fillStyle = 'white'; ctx.textAlign='center'; ctx.textBaseline='middle';
                ctx.fillText(text, 100, 100);
                const data = ctx.getImageData(0,0,200,200).data;
                for(let y=0; y<200; y+=4) {
                    for(let x=0; x<200; x+=4) {
                        if(data[(y*200+x)*4+3]>128) {
                            points.push({ vec: new THREE.Vector3((x-100)/3, -(y-100)/3, 0).multiplyScalar(2), type: 'text', color: new THREE.Color(0xffffff) });
                        }
                    }
                }
            } else if (type === 'cake') {
                const layers = [
                    {y: -16, r: 18, h: 10, type: 'bottom'},
                    {y: -6,  r: 13, h: 8,  type: 'top'}
                ];
                layers.forEach(l => {
                    for(let i=0; i<1000; i++) {
                        const theta = Math.random() * Math.PI * 2;
                        const r = l.r * (0.95 + Math.random()*0.05); 
                        const h = Math.random() * l.h;
                        points.push({ vec: new THREE.Vector3(r*Math.cos(theta), l.y+h, r*Math.sin(theta)), type: 'cake', layer: l.type });
                    }
                    for(let i=0; i<400; i++) {
                        const theta = Math.random() * Math.PI * 2;
                        const r = Math.random() * l.r;
                        points.push({ vec: new THREE.Vector3(r*Math.cos(theta), l.y+l.h, r*Math.sin(theta)), type: 'cake', layer: 'cream' });
                    }
                });
                const candleY = layers[1].y + layers[1].h;
                for(let i=0; i<300; i++) {
                    const h = Math.random() * 12;
                    const r = Math.random() * 0.8;
                    const theta = Math.random() * Math.PI * 2;
                    let col = (Math.sin(h*1.5 + theta)>0) ? new THREE.Color(0xFF0000) : new THREE.Color(0xFFFFFF);
                    points.push({ vec: new THREE.Vector3(r*Math.cos(theta), candleY+h, r*Math.sin(theta)), type: 'candle', color: col });
                }
                const flameY = candleY + 12;
                for(let i=0; i<400; i++) {
                    const u = Math.random();
                    const h = u * 7;
                    const r = (1-u) * 2.0 * Math.random();
                    const theta = Math.random() * Math.PI * 2;
                    let col = new THREE.Color(0xFFA500);
                    if(u<0.2) col.setHex(0x0000FF); else if(u>0.7) col.setHex(0xFF4500);
                    points.push({ vec: new THREE.Vector3(r*Math.cos(theta), flameY+h, r*Math.sin(theta)), type: 'flame', color: col });
                }
                // å¤–ç¯ç²’å­ (Ring)
                for(let i=0; i<600; i++) {
                    const theta = Math.random() * Math.PI * 2;
                    const radius = (i % 2 === 0) ? 35 : 45;
                    const y = (Math.random() - 0.5) * 10 + Math.sin(theta) * 5 - 10;
                    points.push({ vec: new THREE.Vector3(radius*Math.cos(theta), y, radius*Math.sin(theta)), type: 'ring', layer: 'ring' });
                }
            }
            return points;
        }

        // æ ¸å¿ƒï¼šè¿åŠ¨é€»è¾‘ (Lerp 0.08)
        function updateParticles() {
            const positions = particleSystem.geometry.attributes.position.array;
            const colors = particleSystem.geometry.attributes.color.array;
            time += 0.02;
            const blowInfluence = blowProgress / 100;

            for (let i = 0; i < VISUAL_CONFIG.particleCount; i++) {
                const p = particlesData[i];
                let target = p.target.clone();

                // è›‹ç³•æŸ“è‰²
                if (p.type === 'cake') {
                    if (p.layer === 'bottom') p.targetColor.set(CAKE_THEME.bottom);
                    else if (p.layer === 'top') p.targetColor.set(CAKE_THEME.top);
                    else if (p.layer === 'cream') p.targetColor.set(CAKE_THEME.cream);
                }
                // å…‰ç¯æ—‹è½¬
                if (p.type === 'ring') {
                    const angleOffset = time * 0.5;
                    const cos = Math.cos(angleOffset);
                    const sin = Math.sin(angleOffset);
                    const x = target.x * cos - target.z * sin;
                    const z = target.x * sin + target.z * cos;
                    target.x = x; target.z = z;
                    p.targetColor.set(CAKE_THEME.ring);
                }

                // åº†ç¥æ—¶çš„å…¬è½¬
                if (currentState === STATE.CELEBRATION && p.type === 'bg') {
                    const angle = p.angle + time * 0.1 + p.orbitSpeed;
                    const r = p.radius + Math.sin(time * 0.5 + i) * 5;
                    target.x = Math.cos(angle) * r;
                    target.z = Math.sin(angle) * r;
                    target.y = p.baseTarget.y + Math.sin(time + p.noiseOffset) * 2;
                    const hue = 0.9 + (Math.sin(time + i * 0.01) * 0.05); 
                    p.targetColor.setHSL(hue, 0.8, 0.6);
                } 
                // å¾…æœºæ—¶çš„å‘¼å¸
                else if (currentState === STATE.IDLE) {
                    const angle = p.angle + time * 0.1;
                    const r = p.radius + Math.sin(time + i)*2;
                    target.x = Math.cos(angle) * r;
                    target.z = Math.sin(angle) * r;
                    target.y = p.baseTarget.y + Math.sin(time + i * 0.1) * 5;
                }

                // ç«ç„°åŠ¨æ€
                if (p.type === 'flame') {
                    const noise = Math.sin(time * 6 + p.noiseOffset) * 0.6;
                    target.x += noise;
                    if (blowInfluence > 0.1 || currentState === STATE.CELEBRATION) {
                        let lift = blowInfluence * 25;
                        if(currentState === STATE.CELEBRATION) lift = 60;
                        target.y += lift;
                        target.x += (Math.random()-0.5) * lift * 0.8;
                        p.targetColor.lerp(new THREE.Color(0xdddddd), 0.1); 
                    }
                }

                p.current.lerp(target, 0.08);

                positions[i*3] = p.current.x;
                positions[i*3+1] = p.current.y;
                positions[i*3+2] = p.current.z;
                
                colors[i*3] += (p.targetColor.r - colors[i*3]) * 0.1;
                colors[i*3+1] += (p.targetColor.g - colors[i*3+1]) * 0.1;
                colors[i*3+2] += (p.targetColor.b - colors[i*3+2]) * 0.1;
            }

            particleSystem.geometry.attributes.position.needsUpdate = true;
            particleSystem.geometry.attributes.color.needsUpdate = true;
            
            // æ•´ä½“æ—‹è½¬
            if (currentState !== STATE.IDLE) {
                particleSystem.rotation.y = Math.sin(time * 0.15) * 0.15;
            } else {
                particleSystem.rotation.y = 0;
            }
        }

        function transitionTo(key) {
            const targets = shapeCache[key] || [];
            particlesData.forEach((p, i) => {
                if (i < targets.length) {
                    p.baseTarget.copy(targets[i].vec);
                    p.target.copy(targets[i].vec);
                    p.type = targets[i].type;
                    p.layer = targets[i].layer;
                    if(targets[i].color) {
                        p.targetColor = targets[i].color.clone();
                    } else {
                        p.targetColor = new THREE.Color(0xffffff); 
                    }
                    // åˆ‡æ¢æ—¶çš„çˆ†ç‚¸åŠ›
                    const force = 3;
                    p.current.add(new THREE.Vector3((Math.random()-0.5)*force, (Math.random()-0.5)*force, (Math.random()-0.5)*force));
                } else {
                    const angle = Math.random() * Math.PI * 2;
                    const r = 40 + Math.random() * 40;
                    p.baseTarget.set(r*Math.cos(angle), (Math.random()-0.5)*60, r*Math.sin(angle));
                    p.target.copy(p.baseTarget);
                    p.type = 'bg';
                    p.layer = null;
                    p.targetColor = new THREE.Color(0x222222);
                }
            });
        }

        /* --- ä¸šåŠ¡é€»è¾‘ --- */
        document.getElementById('start-btn').addEventListener('click', function() {
            this.innerHTML = '<span class="animate-pulse">Loading...</span>';
            this.disabled = true;
            document.getElementById('loading-text').style.display = 'block';
            
            bgm.volume = 0;
            bgm.play().then(() => {
                let vol = 0;
                const t = setInterval(() => {
                    vol += 0.05;
                    if(vol >= 0.5) { vol = 0.5; clearInterval(t); }
                    bgm.volume = vol;
                }, 200);
            }).catch(e => console.log("BGM Autoplay blocked"));

            initAudio(); 
            initCamera(); 
            initThree(); 
            
            setTimeout(() => {
                document.getElementById('start-overlay').style.display = 'none';
                ui.cameraPreview.classList.remove('hidden-fade');
            }, 1000);
        });

        // å€’æ•°æµç¨‹
        let transitionLock = false;
        function startSequence() {
            if (currentState !== STATE.IDLE || transitionLock) return;
            transitionLock = true;
            currentState = STATE.COUNTDOWN;
            
            // éšè—æ‰‹åŠ¿å›¾æ ‡å’Œé¢„è§ˆ
            ui.handIcon.style.display = 'none';
            ui.cameraPreview.classList.add('hidden-fade');
            
            ui.statusText.innerText = "GESTURE DETECTED";
            ui.statusDot.className = "inline-block w-2 h-2 rounded-full bg-green-500 mr-2 shadow-[0_0_8px_#0f0]";
            
            let count = 3;
            ui.mainText.innerText = "3";
            ui.subText.innerText = "Make a Wish";
            transitionTo('3');

            const timer = setInterval(() => {
                count--;
                if (count > 0) {
                    ui.mainText.innerText = count;
                    transitionTo(count.toString());
                } else {
                    clearInterval(timer);
                    showCake();
                }
            }, 1200);
        }

        function showCake() {
            currentState = STATE.BLOWING;
            transitionTo('cake');
            
            ui.mainText.innerText = "";
            ui.subText.innerText = "";
            ui.blowHint.style.opacity = '1';
            ui.blowMeter.style.opacity = '1';
            
            ui.statusText.innerText = "MIC LISTENING...";
        }

        function successCelebration() {
            currentState = STATE.CELEBRATION;
            ui.statusText.innerText = "WISH GRANTED";
            ui.blowMeter.style.opacity = '0';
            ui.blowHint.style.opacity = '0';
            
            // ç²’å­çˆ†ç‚¸
            particlesData.forEach(p => {
                if (p.type === 'cake' || p.type === 'candle' || p.type === 'ring') {
                    p.target.y += Math.sin(p.current.x * 0.5) * 0.5; // è›‹ç³•æ¬¢å‘¼
                } else if (p.type !== 'flame') {
                    p.type = 'bg'; // èƒŒæ™¯æ•£å¼€
                }
            });

            setTimeout(() => {
                ui.surpriseLayer.classList.add('active');
                ui.revealBtn.classList.remove('hidden');
            }, 1500);
        }

        /* --- ç¡¬ä»¶ä¸äº¤äº’ --- */
        function initAudio() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) return;
            navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 256;
                const source = audioContext.createMediaStreamSource(stream);
                source.connect(analyser);
                checkAudio();
            }).catch(e => ui.statusText.innerText = "MIC DENIED");
        }

        function checkAudio() {
            requestAnimationFrame(checkAudio);
            if (currentState !== STATE.BLOWING) return;
            
            let volume = 0;
            if (analyser) {
                const data = new Uint8Array(analyser.frequencyBinCount);
                analyser.getByteFrequencyData(data);
                let sum = 0; for(let i=0; i<data.length; i++) sum += data[i];
                volume = sum / data.length;
            }
            
            // éŸ³é‡æˆ–é•¿æŒ‰è§¦å‘
            if (volume > 20 || isTouching || isSpacePressed) {
                isBlowing = true;
                blowProgress += 0.5;
            } else {
                isBlowing = false;
                blowProgress -= 0.3;
            }
            blowProgress = Math.max(0, Math.min(100, blowProgress));
            ui.blowBar.style.width = blowProgress + '%';
            if (blowProgress >= 100) successCelebration();
        }

        // æ‘„åƒå¤´é€»è¾‘
        function initCamera() {
            if (typeof Camera === 'undefined') {
                alert("ç»„ä»¶æœªåŠ è½½å®Œæˆï¼Œè¯·åˆ·æ–°é¡µé¢ã€‚æˆ–ç›´æ¥ä½¿ç”¨è§¦æ§æ¨¡å¼ã€‚");
                return;
            }
            const video = document.getElementsByClassName('input_video')[0];
            const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4.1646424915/${file}`});
            hands.setOptions({ maxNumHands: 1, modelComplexity: 0, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });
            
            ui.outputCanvas.width = 320; ui.outputCanvas.height = 240;
            const ctx = ui.outputCanvas.getContext('2d');

            hands.onResults(results => {
                ctx.save(); ctx.clearRect(0,0,320,240); ctx.drawImage(results.image,0,0,320,240);
                if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                    ui.camIndicator.classList.replace('bg-red-500', 'bg-emerald-400');
                    ui.camIndicator.classList.add('shadow-[0_0_8px_#34d399]');
                    ui.camStatus.innerText = "DETECTED";
                    ui.camStatus.className = "text-[9px] text-emerald-400 font-bold";
                    
                    const hand = results.multiHandLandmarks[0];
                    drawConnectors(ctx, hand, HAND_CONNECTIONS, {color: '#34d399', lineWidth: 3});
                    drawLandmarks(ctx, hand, {color: '#ffffff', lineWidth: 1, radius: 2});

                    if (currentState === STATE.IDLE) startSequence();
                } else {
                    ui.camIndicator.classList.replace('bg-emerald-400', 'bg-red-500');
                    ui.camStatus.innerText = "WAITING...";
                    ui.camStatus.className = "text-[9px] text-slate-400";
                }
                ctx.restore();
            });

            const camera = new Camera(video, { onFrame: async () => { await hands.send({image: video}); }, width: 320, height: 240 });
            camera.start().catch(e => {
                console.error(e);
                ui.cameraPreview.style.display = 'none';
            });
        }

        function animate() {
            requestAnimationFrame(animate);
            updateParticles();
            renderer.render(scene, camera);
        }

        // äº¤äº’ç›‘å¬
        document.addEventListener('touchstart', (e) => { if(currentState === STATE.BLOWING && !e.target.closest('button')) isTouching = true; }, {passive: false});
        document.addEventListener('touchend', () => isTouching = false);
        document.addEventListener('mousedown', (e) => { if(currentState === STATE.BLOWING && !e.target.closest('button')) isTouching = true; });
        document.addEventListener('mouseup', () => isTouching = false);
        document.addEventListener('keydown', (e) => { if(e.code === 'Space') isSpacePressed = true; });
        document.addEventListener('keyup', (e) => { if(e.code === 'Space') isSpacePressed = false; });

        // UI é€»è¾‘
        ui.revealBtn.addEventListener('click', (e) => { e.stopPropagation(); ui.revealBtn.classList.add('hidden'); ui.cardContainer.classList.remove('hidden'); });
        ui.nextBtn.addEventListener('click', (e) => { 
            e.stopPropagation(); ui.cardContainer.classList.add('flipped'); 
            const wishes = ["ç”Ÿæ—¥å¿«ä¹ï¼", "æ„¿ä½ éå†å±±æ²³ï¼Œè§‰å¾—äººé—´å€¼å¾—ã€‚", "æ„¿ä½ çœ¼é‡Œçš„æ˜Ÿæ˜Ÿæ°¸è¿œå‘äº®ï¼Œ", "å¿ƒä¸­çš„å¤ªé˜³æ°¸è¿œæ»šçƒ«ã€‚", "æ–°çš„ä¸€å²ï¼Œè¯·ç»§ç»­è‡ªç”±ã€çƒ­çƒˆã€é—ªé—ªå‘å…‰ï¼"];
            let line = 0, char = 0; ui.typewriter.innerHTML = "";
            function type() {
                if(line < wishes.length) {
                    if(char < wishes[line].length) { ui.typewriter.innerHTML += wishes[line].charAt(char++); setTimeout(type, 100); }
                    else { ui.typewriter.innerHTML += "<br>"; line++; char=0; setTimeout(type, 300); }
                }
            }
            setTimeout(type, 400);
        });
        ui.closeBtn.addEventListener('click', (e) => { e.stopPropagation(); ui.cardContainer.classList.add('hidden'); ui.revealBtn.classList.remove('hidden'); ui.cardContainer.classList.remove('flipped'); });
        document.getElementById('music-btn').addEventListener('click', () => { if(bgm.paused) bgm.play(); else bgm.pause(); });

    </script>
</body>
</html>